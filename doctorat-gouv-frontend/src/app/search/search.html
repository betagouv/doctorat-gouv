<app-header></app-header>

<div class="search-form">
  <div class="form-content">

    <h1 class="fr-h1 fr-text--center">
      Trouver une offre de th√®se ou d‚Äôaccompagnement
    </h1>

    <!-- ===================== BARRE DE RECHERCHE ===================== -->
    <div class="custom-search-bar">
      <div class="custom-input-wrapper">
        <span class="custom-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
        </span>

        <input type="search"
               id="query"
               name="query"
               class="custom-input"
               placeholder="Rechercher par titre ou mot cl√©s"
               [(ngModel)]="query"
               (ngModelChange)="onFilterChange()"
               aria-label="Champ de recherche">
      </div>
    </div>

    <!-- ===================== LIGNE 1 : 3 DROPDOWNS ===================== -->
    <div class="filters-grid fr-grid-row fr-grid-row--gutters fr-mt-4w">

      <!-- DISCIPLINE -->
      <div class="fr-col-12 fr-col-md-4">
        <div class="dropdown-filter">
          <button class="dropdown-btn" (click)="toggleDropdown('disciplineOpen')">
            {{ discipline || 'Discipline' }}
            <span class="fr-icon-arrow-down-s-line"></span>
          </button>

          <div class="dropdown-panel" *ngIf="disciplineOpen">

            <div class="search-box">
              <span class="search-icon">üîç</span>
              <input type="text"
                     class="search-input"
                     placeholder="Rechercher"
                     [(ngModel)]="disciplineSearch">
            </div>

            <div class="fr-checkbox-group fr-mb-2w">
              <input type="checkbox"
                     id="discipline_all"
                     [checked]="!discipline"
                     (change)="resetFilter('discipline')">
              <label for="discipline_all">Tout s√©lectionner</label>
            </div>

            <div class="checkbox-list">
              <div class="fr-checkbox-group"
                   *ngFor="let opt of filteredOptions(disciplineOpts, disciplineSearch)">
                <input type="checkbox"
                       [id]="'discipline_' + opt"
                       [checked]="discipline === opt"
                       (change)="selectSingle('discipline', opt)">
                <label [for]="'discipline_' + opt">{{ opt }}</label>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- DEFIS DE SOCIETE -->
      <div class="fr-col-12 fr-col-md-4">
        <div class="dropdown-filter">
          <button class="dropdown-btn" (click)="toggleDropdown('defisSocieteOpen')">
            {{ defisSociete || 'D√©fis de soci√©t√©' }}
            <span class="fr-icon-arrow-down-s-line"></span>
          </button>

          <div class="dropdown-panel" *ngIf="defisSocieteOpen">

            <div class="search-box">
              <span class="search-icon">üîç</span>
              <input type="text"
                     class="search-input"
                     placeholder="Rechercher"
                     [(ngModel)]="defisSocieteSearch">
            </div>

            <div class="fr-checkbox-group fr-mb-2w">
              <input type="checkbox"
                     id="defisSociete_all"
                     [checked]="!defisSociete"
                     (change)="resetFilter('defisSociete')">
              <label for="defisSociete_all">Tout s√©lectionner</label>
            </div>

            <div class="checkbox-list">
              <div class="fr-checkbox-group"
                   *ngFor="let opt of filteredOptions(defisSocieteOpts, defisSocieteSearch)">
                <input type="checkbox"
                       [id]="'defisSociete_' + opt"
                       [checked]="defisSociete === opt"
                       (change)="selectSingle('defisSociete', opt)">
                <label [for]="'defisSociete_' + opt">{{ opt }}</label>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- LOCALISATION -->
      <div class="fr-col-12 fr-col-md-4">
        <div class="dropdown-filter">
          <button class="dropdown-btn" (click)="toggleDropdown('localisationOpen')">
            {{ localisation || 'Localisation g√©ographique' }}
            <span class="fr-icon-arrow-down-s-line"></span>
          </button>

          <div class="dropdown-panel" *ngIf="localisationOpen">

            <div class="search-box">
              <span class="search-icon">üîç</span>
              <input type="text"
                     class="search-input"
                     placeholder="Rechercher"
                     [(ngModel)]="localisationSearch">
            </div>

            <div class="fr-checkbox-group fr-mb-2w">
              <input type="checkbox"
                     id="localisation_all"
                     [checked]="!localisation"
                     (change)="resetFilter('localisation')">
              <label for="localisation_all">Tout s√©lectionner</label>
            </div>

            <div class="checkbox-list">
              <div class="fr-checkbox-group"
                   *ngFor="let opt of filteredOptions(localisationOpts, localisationSearch)">
                <input type="checkbox"
                       [id]="'localisation_' + opt"
                       [checked]="localisation === opt"
                       (change)="selectSingle('localisation', opt)">
                <label [for]="'localisation_' + opt">{{ opt }}</label>
              </div>
            </div>

          </div>
        </div>
      </div>

    </div>

    <!-- ===================== LIGNE 2 : 2 DROPDOWNS ===================== -->
    <div class="filters-grid fr-grid-row fr-grid-row--gutters fr-mt-2w"
         *ngIf="showMoreFilters">

      <!-- LABORATOIRE -->
      <div class="fr-col-12 fr-col-md-4">
        <div class="dropdown-filter">
          <button class="dropdown-btn" (click)="toggleDropdown('laboratoireOpen')">
            {{ laboratoire || 'Laboratoire de recherche' }}
            <span class="fr-icon-arrow-down-s-line"></span>
          </button>

          <div class="dropdown-panel" *ngIf="laboratoireOpen">

            <div class="search-box">
              <span class="search-icon">üîç</span>
              <input type="text"
                     class="search-input"
                     placeholder="Rechercher"
                     [(ngModel)]="laboratoireSearch">
            </div>

            <div class="fr-checkbox-group fr-mb-2w">
              <input type="checkbox"
                     id="laboratoire_all"
                     [checked]="!laboratoire"
                     (change)="resetFilter('laboratoire')">
              <label for="laboratoire_all">Tout s√©lectionner</label>
            </div>

            <div class="checkbox-list">
              <div class="fr-checkbox-group"
                   *ngFor="let opt of filteredOptions(laboratoireOpts, laboratoireSearch)">
                <input type="checkbox"
                       [id]="'laboratoire_' + opt"
                       [checked]="laboratoire === opt"
                       (change)="selectSingle('laboratoire', opt)">
                <label [for]="'laboratoire_' + opt">{{ opt }}</label>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- ECOLE -->
      <div class="fr-col-12 fr-col-md-4">
        <div class="dropdown-filter">
          <button class="dropdown-btn" (click)="toggleDropdown('ecoleOpen')">
            {{ ecole || '√âtablissement dipl√¥mant' }}
            <span class="fr-icon-arrow-down-s-line"></span>
          </button>

          <div class="dropdown-panel" *ngIf="ecoleOpen">

            <div class="search-box">
              <span class="search-icon">üîç</span>
              <input type="text"
                     class="search-input"
                     placeholder="Rechercher"
                     [(ngModel)]="ecoleSearch">
            </div>

            <div class="fr-checkbox-group fr-mb-2w">
              <input type="checkbox"
                     id="ecole_all"
                     [checked]="!ecole"
                     (change)="resetFilter('ecole')">
              <label for="ecole_all">Tout s√©lectionner</label>
            </div>

            <div class="checkbox-list">
              <div class="fr-checkbox-group"
                   *ngFor="let opt of filteredOptions(ecoleOpts, ecoleSearch)">
                <input type="checkbox"
                       [id]="'ecole_' + opt"
                       [checked]="ecole === opt"
                       (change)="selectSingle('ecole', opt)">
                <label [for]="'ecole_' + opt">{{ opt }}</label>
              </div>
            </div>

          </div>
        </div>
      </div>

    </div>

    <!-- ===================== ACTIONS ===================== -->
    <div class="fr-grid-row fr-mt-2w actions-row">
      <div class="fr-col-12 fr-col-md-6 fr-text--left">
        <a href="javascript:void(0)"
           class="fr-link toggle-filters"
           (click)="toggleFilters()">
          {{ showMoreFilters ? 'Moins de filtres' : 'Plus de filtres' }}
        </a>
      </div>
    </div>

  </div>
</div>

<main class="fr-container fr-py-4w search-main">

  <section class="fr-tags-group fr-mt-4w"
           *ngIf="discipline || defisSociete || localisation || laboratoire || ecole">
    <p class="fr-text--bold">Filtres actifs :</p>
    <ul class="fr-tags-group__list">

      <li *ngIf="discipline">
        <span class="fr-tag">
          Discipline : {{ discipline }}
          <button class="fr-tag__btn" (click)="removeFilter('discipline')" title="Supprimer">√ó</button>
        </span>
      </li>

      <li *ngIf="defisSociete">
        <span class="fr-tag">
          D√©fis soci√©t√© : {{ defisSociete }}
          <button class="fr-tag__btn" (click)="removeFilter('defisSociete')" title="Supprimer">√ó</button>
        </span>
      </li>

      <li *ngIf="localisation">
        <span class="fr-tag">
          Localisation : {{ localisation }}
          <button class="fr-tag__btn" (click)="removeFilter('localisation')" title="Supprimer">√ó</button>
        </span>
      </li>

      <li *ngIf="laboratoire">
        <span class="fr-tag">
          Laboratoire : {{ laboratoire }}
          <button class="fr-tag__btn" (click)="removeFilter('laboratoire')" title="Supprimer">√ó</button>
        </span>
      </li>

      <li *ngIf="ecole">
        <span class="fr-tag">
          √âtablissement : {{ ecole }}
          <button class="fr-tag__btn" (click)="removeFilter('ecole')" title="Supprimer">√ó</button>
        </span>
      </li>

    </ul>
  </section>

  <!-- ===================== R√âSULTATS ===================== -->
  <section class="fr-mt-4w" *ngIf="results.length">

    <p id="results-count" tabindex="-1" class="fr-text--l custom-blue">
      <span class="fr-text--bold custom-bold">{{ totalResults }} r√©sultats</span>
      de recherche
    </p>
	
	<div class="info-bulle-these">
		<!--		<div class="info-bulle-icon">-->
		<!--			üí°-->
		<!--		</div>-->
		<img src="assets/info-bulle.png" alt="Information" class="info-bulle-icon" />
		<p class="info-bulle-text">
			Un projet doctoral est une construction progressive : si un sujet s'approche
			de votre th√©matique de recherche, n'h√©sitez pas √† candidater et √† √©changer
			avec le directeur de th√®se pour en pr√©ciser la d√©finition.
		</p>
	</div>

    <div *ngIf="view === 'liste'" class="fr-grid-row fr-grid-row--gutters fr-mt-2w">

      <div class="fr-col-12 fr-col-md-6 fr-col-lg-4"
           *ngFor="let thesis of results">

        <div class="fr-card fr-card--shadow fr-card--sm card-clickable" (click)="thesis.id && goToDetail(thesis.id)">

          <div class="fr-card__img">
            <img [src]="getImageForThesis(thesis)"
                 alt="Illustration de la th√®se" />

            <span class="fr-tag badge badge-green"
                  *ngIf="getFirstDomaine(thesis)">
              {{ getFirstDomaineWithMaxLength(thesis, 60) }}
            </span>

            <span class="fr-tag badge badge-pink"
                  *ngIf="thesis?.specialite">
              {{ thesis.specialite }}
            </span>
          </div>

          <div class="fr-card__body">
            <h3 class="fr-card__title custom-blue">
              {{ limitWords(thesis.theseTitre, 30) }}
            </h3><br/>

            <p class="fr-card__desc">
              {{ getResumeOrFallback(thesis, 30) }}<br/><br/>

              <ng-container *ngIf="thesis.motsCles">
                <strong>Mots cl√©s :</strong>
                <div class="fr-tags-group fr-tags-group--column">
                  <span class="fr-tag violet"
                        *ngFor="let entry of getEntries(thesis.motsCles)">
                    {{ entry[1] }}
                  </span>
                </div>
              </ng-container>
            </p>
          </div>

          <div class="fr-card__footer">
            <a [routerLink]="['/proposition']"
               [queryParams]="{ id: thesis.id }"
               class="arrow-link">
              Voir d√©tail
            </a>
          </div>

        </div>
      </div>

      <!-- PAGINATION -->
      <div class="fr-container fr-my-4w pagination-fixed">
        <nav class="fr-pagination"
             role="navigation"
             aria-label="Pagination"
             *ngIf="totalPages > 1">

          <ul class="fr-pagination__list">

            <li>
              <button class="fr-pagination__link"
                      (click)="goToPage(currentPage - 1)"
                      [disabled]="currentPage === 0">
                <span class="fr-icon-arrow-left-s-line"></span>
                <span class="fr-mx-1w">Pr√©c√©dent</span>
              </button>
            </li>

            <li>
              <button class="fr-pagination__link"
                      (click)="goToPage(0)"
                      [class.fr-pagination__link--current]="currentPage === 0">
                1
              </button>
            </li>

            <li *ngIf="currentPage > 3"><span class="fr-pagination__link">‚Ä¶</span></li>

            <li *ngFor="let i of getPagesAround()">
              <button class="fr-pagination__link"
                      (click)="goToPage(i)"
                      [class.fr-pagination__link--current]="currentPage === i">
                {{ i + 1 }}
              </button>
            </li>

            <li *ngIf="currentPage < totalPages - 4"><span class="fr-pagination__link">‚Ä¶</span></li>

            <li>
              <button class="fr-pagination__link"
                      (click)="goToPage(totalPages - 1)"
                      [class.fr-pagination__link--current]="currentPage === totalPages - 1">
                {{ totalPages }}
              </button>
            </li>

            <li>
              <button class="fr-pagination__link"
                      (click)="goToPage(currentPage + 1)"
                      [disabled]="currentPage === totalPages - 1">
                <span class="fr-mx-1w">Suivant</span>
                <span class="fr-icon-arrow-right-s-line"></span>
              </button>
            </li>

          </ul>
        </nav>
      </div>

    </div>

  </section>
</main>
